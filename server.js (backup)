const express = require('express');
const path = require('path');
const cors = require('cors');
const session = require('express-session');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

// Importa la configurazione database
const { testConnection, db } = require('./config/database');

const app = express();

// ========== SECURITY MIDDLEWARE ==========
app.use(helmet({
    contentSecurityPolicy: false, // Disabilita per ora, pu√≤ bloccare script inline
    crossOriginEmbedderPolicy: false
}));

// Rate limiting
const limiter = rateLimit({
    windowMs: 15 * 60 * 1000, // 15 minuti
    max: 1000, // limite per IP
    message: 'Troppe richieste da questo IP'
});
app.use('/api/', limiter);

// ========== MIDDLEWARE BASE ==========
app.use(cors());
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// ========== CONFIGURAZIONE SESSIONI ==========
app.use(session({
    secret: process.env.SESSION_SECRET || 'kilwinning_presenze_secret_2025_super_strong',
    resave: true,
    saveUninitialized: false,
    rolling: true,
    name: 'kilwinning_session',
    cookie: {
        secure: false,
        httpOnly: true,
        maxAge: 8 * 60 * 60 * 1000,
        sameSite: 'lax'
    },
    genid: function(req) {
        return 'kilw_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
}));

// Middleware per loggare sessioni (DEBUG)
app.use((req, res, next) => {
    if (req.path.startsWith('/admin') || req.path.startsWith('/fratelli')) {
        console.log(`üîç ${req.method} ${req.path} - Session: ${req.sessionID} - User: ${req.session?.user?.username || 'none'}`);
    }
    next();
});

// ========== ROTTE MODULARI ==========

// Area admin (pagine HTML)
app.use('/admin', require('./routes/admin'));

// API Routes
app.use('/api/presenze', require('./routes/presenze'));
app.use('/api/tornate', require('./routes/tornate'));

// ========== API FRATELLI (INLINE) ==========

// ‚úÖ API: Login fratelli con controllo privilegi admin
app.post('/api/fratelli/login', async (req, res) => {
    try {
        const { nome } = req.body;
        
        console.log('üîê Tentativo login fratello:', nome);
        
        if (!nome) {
            return res.status(400).json({
                success: false,
                message: 'Nome obbligatorio'
            });
        }
        
        // Cerca il fratello nel database
        const fratelli = await db.getFratelli();
        const fratello = fratelli.find(f => 
            f.nome.toLowerCase().trim() === nome.toLowerCase().trim()
        );
        
        if (!fratello) {
            console.log('‚ùå Fratello non trovato:', nome);
            return res.status(401).json({
                success: false,
                message: 'Fratello non riconosciuto'
            });
        }
        
        // ‚úÖ CONTROLLO PRIVILEGI ADMIN
        const adminUsers = ['Paolo Giulio Gazzano', 'Emiliano Menicucci'];
        const hasAdminAccess = adminUsers.includes(fratello.nome);
        
        // Crea sessione fratello
        req.session.user = {
            id: fratello.id,
            username: fratello.nome,
            nome: fratello.nome,
            grado: fratello.grado,
            cariche_fisse: fratello.cariche_fisse,
            ruolo: 'fratello',
            admin_access: hasAdminAccess, // ‚úÖ FLAG IMPORTANTE!
            loginTime: new Date().toISOString(),
            lastActivity: new Date().toISOString()
        };
        
        // Salva sessione
        req.session.save((err) => {
            if (err) {
                console.error('‚ùå Errore salvataggio sessione:', err);
                return res.status(500).json({
                    success: false,
                    message: 'Errore interno sessione'
                });
            }
            
            console.log(`‚úÖ Login fratello successful:`, fratello.nome, 
                       hasAdminAccess ? '(CON PRIVILEGI ADMIN)' : '(senza privilegi admin)');
            
            res.json({
                success: true,
                user: req.session.user,
                admin_access: hasAdminAccess,
                sessionId: req.sessionID
            });
        });
        
    } catch (error) {
        console.error('‚ùå Errore login fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore interno del server'
        });
    }
});

// ‚úÖ API: Verifica sessione fratello (VERSIONE CORRETTA)
app.get('/api/fratelli/me', async (req, res) => {
    console.log('üîç [DEBUG] /api/fratelli/me chiamata');
    console.log('üîç [DEBUG] Session ID:', req.sessionID);
    console.log('üîç [DEBUG] Session user:', req.session?.user?.nome);
    
    try {
        // ‚úÖ TIMEOUT PER EVITARE 503
        const timeout = setTimeout(() => {
            console.error('‚ùå [DEBUG] TIMEOUT - Risposta dopo 5 secondi');
            if (!res.headersSent) {
                res.status(503).json({
                    success: false,
                    error: 'Database timeout',
                    message: 'Server temporaneamente non disponibile',
                    debug: 'Timeout dopo 5 secondi'
                });
            }
        }, 5000);

        if (req.session && req.session.user) {
            // Aggiorna ultima attivit√†
            req.session.user.lastActivity = new Date().toISOString();
            
            // ‚úÖ SALVATAGGIO SESSIONE CON ERROR HANDLING
            req.session.save((err) => {
                clearTimeout(timeout);
                
                if (err) {
                    console.error('‚ùå [DEBUG] Errore salvataggio sessione:', err);
                    if (!res.headersSent) {
                        return res.status(500).json({
                            success: false,
                            error: 'Session save error',
                            message: 'Errore interno sessione',
                            debug: err.message
                        });
                    }
                    return;
                }
                
                console.log('‚úÖ [DEBUG] Sessione fratello valida per:', req.session.user.nome);
                
                if (!res.headersSent) {
                    res.json({
                        success: true,
                        authenticated: true,
                        user: req.session.user,
                        sessionId: req.sessionID,
                        debug: 'Session loaded successfully'
                    });
                }
            });
        } else {
            clearTimeout(timeout);
            console.log('‚ùå [DEBUG] Sessione fratello non trovata o invalida');
            
            if (!res.headersSent) {
                res.status(401).json({
                    success: false,
                    authenticated: false,
                    message: 'Sessione non valida',
                    debug: 'No valid session found'
                });
            }
        }
        
    } catch (error) {
        clearTimeout(timeout);
        console.error('üí• [DEBUG] Errore catturato in /api/fratelli/me:', error);
        
        if (!res.headersSent) {
            res.status(503).json({
                success: false,
                error: 'Server error',
                message: 'Errore interno del server',
                debug: error.message,
                stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
            });
        }
    }
});

// ‚úÖ API: Logout fratello
app.post('/api/fratelli/logout', (req, res) => {
    console.log('üö™ Logout fratello:', req.session?.user?.nome);
    
    req.session.destroy((err) => {
        if (err) {
            console.error('‚ùå Errore logout:', err);
            return res.status(500).json({ success: false });
        }
        
        res.clearCookie('kilwinning_session');
        console.log('‚úÖ Logout fratello completato');
        
        res.json({ success: true, redirect: '/' });
    });
});

// ‚úÖ API DI TEST DATABASE
app.get('/api/test/db', async (req, res) => {
    console.log('üîç [DEBUG] Test connessione database');
    
    try {
        // Test semplice connessione database
        const testQuery = await db.executeQuery('SELECT 1 as test');
        console.log('‚úÖ [DEBUG] Database connesso:', testQuery);
        
        res.json({
            success: true,
            message: 'Database connesso',
            test_result: testQuery,
            timestamp: new Date().toISOString()
        });
        
    } catch (error) {
        console.error('‚ùå [DEBUG] Errore connessione database:', error);
        
        res.status(503).json({
            success: false,
            error: 'Database error',
            message: 'Errore connessione database',
            debug: error.message
        });
    }
});

// ‚úÖ API HEALTH CHECK
app.get('/api/health', (req, res) => {
    console.log('üîç [DEBUG] Health check');
    
    res.json({
        status: 'online',
        timestamp: new Date().toISOString(),
        uptime: process.uptime(),
        memory: process.memoryUsage(),
        version: '1.0.0'
    });
});

// ========== ALTRE API FRATELLI ==========

// GET /api/fratelli - Lista tutti i fratelli
app.get('/api/fratelli', async (req, res) => {
    try {
        console.log('üîç API: Caricamento lista fratelli');
        
        const fratelli = await db.getFratelli();
        
        console.log(`‚úÖ Caricati ${fratelli.length} fratelli`);
        res.json(fratelli);
        
    } catch (error) {
        console.error('‚ùå Errore API fratelli:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nel caricamento dei fratelli',
            error: error.message
        });
    }
});

// GET /api/fratelli/:id - Dettagli singolo fratello
app.get('/api/fratelli/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const fratello = await db.getFratelloById(id);
        
        if (!fratello) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        res.json({
            success: true,
            data: fratello
        });
        
    } catch (error) {
        console.error('‚ùå Errore API fratello singolo:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nel recupero del fratello',
            error: error.message
        });
    }
});

// POST /api/fratelli - Crea nuovo fratello
app.post('/api/fratelli', async (req, res) => {
    try {
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        if (!nome || !grado) {
            return res.status(400).json({
                success: false,
                message: 'Nome e grado sono obbligatori'
            });
        }
        
        const result = await db.addFratello(nome, grado, cariche, cariche_fisse);
        
        res.status(201).json({
            success: true,
            message: 'Fratello creato con successo',
            data: {
                id: result.insertId,
                nome,
                grado,
                cariche,
                cariche_fisse
            }
        });
        
    } catch (error) {
        console.error('‚ùå Errore creazione fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nella creazione del fratello',
            error: error.message
        });
    }
});

// PUT /api/fratelli/:id - Aggiorna fratello
app.put('/api/fratelli/:id', async (req, res) => {
    try {
        const { id } = req.params;
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        const fratelloEsistente = await db.getFratelloById(id);
        if (!fratelloEsistente) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        await db.updateFratello(id, nome, grado, cariche, cariche_fisse);
        
        res.json({
            success: true,
            message: 'Fratello aggiornato con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore aggiornamento fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'aggiornamento del fratello',
            error: error.message
        });
    }
});

// DELETE /api/fratelli/:id - Elimina fratello
app.delete('/api/fratelli/:id', async (req, res) => {
    try {
        const { id } = req.params;
        
        const fratello = await db.getFratelloById(id);
        if (!fratello) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        await db.deleteFratello(id);
        
        res.json({
            success: true,
            message: 'Fratello eliminato con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore eliminazione fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'eliminazione del fratello',
            error: error.message
        });
    }
});

// GET /api/fratelli/:id/tornate - Tornate del fratello
app.get('/api/fratelli/:id/tornate', async (req, res) => {
    try {
        const fratelloId = req.params.id;
        const { future, limit } = req.query;
        
        console.log(`üîç API Tornate Fratello ${fratelloId} - Future: ${future}, Limit: ${limit}`);
        
        let query = `
            SELECT 
                t.id,
                t.data,
                t.orario_inizio,
                t.discussione,
                t.location,
                t.tipo,
                t.stato,
                t.cena,
                t.costo_cena,
                t.descrizione_cena,
                t.argomento_istruzione,
                t.orario_istruzione,
                t.note,
                f.nome as chi_introduce_nome,
                p.presente as presenza_confermata,
                p.ruolo as ruolo_fratello
            FROM tornate t
            LEFT JOIN fratelli f ON t.chi_introduce = f.id
            LEFT JOIN presenze p ON t.id = p.tornata_id AND p.fratello_id = ?
        `;
        
        const params = [fratelloId];
        
        // Filtro per tornate future
        if (future === 'true') {
            query += ' WHERE t.data >= CURDATE()';
        }
        
        query += ' ORDER BY t.data ASC';
        
        // Limite risultati
        if (limit && !isNaN(limit)) {
            query += ' LIMIT ?';
            params.push(parseInt(limit));
        }
        
        const results = await db.executeQuery(query, params);
        
        console.log(`‚úÖ Trovate ${results.length} tornate per fratello ${fratelloId}`);
        
        // Formato compatibile con le pagine
        const tornate = results.map(t => ({
            id: t.id,
            data: t.data,
            orario: t.orario_inizio || '19:30:00',
            titolo: t.discussione || 'Tornata',
            tipo: t.tipo || 'ordinaria',
            luogo: t.location || 'Tolfa',
            stato: t.stato || 'programmata',
            cena: t.cena === 1,
            costo_cena: t.costo_cena,
            descrizione_cena: t.descrizione_cena,
            argomento_istruzione: t.argomento_istruzione,
            orario_istruzione: t.orario_istruzione,
            note: t.note,
            chi_introduce: t.chi_introduce_nome,
            presenza_confermata: t.presenza_confermata,
            ruolo: t.ruolo_fratello
        }));
        
        // Risposta in formato compatibile con dashboard
        if (future === 'true') {
            res.json({
                success: true,
                data: { tornate: tornate }
            });
        } else {
            // Per la pagina tornate.html
            res.json(tornate);
        }
        
    } catch (error) {
        console.error('‚ùå Errore API tornate fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nel caricamento delle tornate',
            error: error.message,
            data: { tornate: [] }
        });
    }
});

// GET /api/fratelli/:id/statistiche - Statistiche presenza fratello
app.get('/api/fratelli/:id/statistiche', async (req, res) => {
    console.log(`üìä API Statistiche - Fratello ID: ${req.params.id}`);
    
    try {
        const fratelloId = req.params.id;
        const anno = new Date().getFullYear();
        
        // Query per statistiche reali dal database
        const stats = await db.executeQuery(`
            SELECT 
                COUNT(DISTINCT t.id) as totali_tornate,
                COUNT(DISTINCT CASE WHEN p.presente = 1 THEN t.id END) as presenze_count,
                COUNT(DISTINCT CASE WHEN p.presente = 0 THEN t.id END) as assenze_count
            FROM tornate t
            LEFT JOIN presenze p ON t.id = p.tornata_id AND p.fratello_id = ?
            WHERE YEAR(t.data) = ? AND t.data <= CURDATE()
        `, [fratelloId, anno]);
        
        const totaleTornate = stats[0]?.totali_tornate || 0;
        const presenzeCount = stats[0]?.presenze_count || 0;
        const assenzeCount = stats[0]?.assenze_count || 0;
        const percentuale = totaleTornate > 0 ? Math.round((presenzeCount / totaleTornate) * 100) : 0;
        
        console.log(`üìà Statistiche calcolate: ${presenzeCount}/${totaleTornate} (${percentuale}%)`);
        
        res.json({
            success: true,
            totaliTornate: totaleTornate,
            presenzeCount: presenzeCount,
            assenzeCount: assenzeCount,
            percentuale: percentuale,
            anno: anno
        });
        
    } catch (error) {
        console.error('‚ùå Errore statistiche:', error);
        
        // Fallback con dati ragionevoli
        res.json({
            success: false,
            totaliTornate: 11,
            presenzeCount: 8,
            assenzeCount: 3,
            percentuale: 73,
            error: error.message
        });
    }
});

// POST /api/fratelli/:id/presenza - Conferma presenza fratello
app.post('/api/fratelli/:id/presenza', async (req, res) => {
    try {
        const { id } = req.params;
        const { tornataId, presente } = req.body;
        
        console.log(`‚úÖ Salvataggio presenza: Fratello ${id}, Tornata ${tornataId}, Presente: ${presente}`);
        
        // Verifica che la tornata esista
        const tornata = await db.executeQuery('SELECT id FROM tornate WHERE id = ?', [tornataId]);
        if (tornata.length === 0) {
            return res.status(404).json({ 
                success: false, 
                error: 'Tornata non trovata',
                message: 'La tornata specificata non esiste'
            });
        }
        
        // Usa UPSERT corretto per MySQL
        const query = `
            INSERT INTO presenze (fratello_id, tornata_id, presente, data_creazione, data_aggiornamento)
            VALUES (?, ?, ?, NOW(), NOW())
            ON DUPLICATE KEY UPDATE 
                presente = VALUES(presente),
                data_aggiornamento = NOW()
        `;
        
        const result = await db.executeQuery(query, [id, tornataId, presente ? 1 : 0]);
        
        console.log(`üíæ Presenza salvata nel database - Result:`, result);
        
        if (result.affectedRows === 0) {
            throw new Error('Nessuna riga modificata nel database');
        }
        
        // Recupera la presenza aggiornata per conferma
        const conferma = await db.executeQuery(`
            SELECT p.presente, t.data, t.discussione 
            FROM presenze p 
            JOIN tornate t ON p.tornata_id = t.id 
            WHERE p.fratello_id = ? AND p.tornata_id = ?
        `, [id, tornataId]);
        
        console.log(`üîç Conferma salvataggio:`, conferma);
        
        res.json({ 
            success: true, 
            message: `Presenza ${presente ? 'confermata' : 'rimossa'} con successo`,
            data: {
                fratello_id: parseInt(id),
                tornata_id: parseInt(tornataId),
                presente: presente,
                saved_in_db: true,
                conferma: conferma[0] || null
            }
        });
        
    } catch (error) {
        console.error('‚ùå Errore API presenza:', error);
        res.status(500).json({ 
            success: false, 
            error: 'Errore nel salvataggio della presenza',
            message: error.message,
            details: {
                fratello_id: req.params.id,
                tornata_id: req.body.tornataId,
                presente: req.body.presente
            }
        });
    }
});

// üîß CORREZIONE CRITICA: Aggiungi queste API ADMIN PROTETTE nel server.js

// ‚úÖ AGGIUNGI QUESTE ROUTE DOPO LE API FRATELLI ESISTENTI (intorno alla riga 400):

// üîß AGGIUNGI QUESTE API AL SERVER.JS (dopo le API fratelli esistenti)

// ========== MIDDLEWARE ADMIN ==========
function requireAdminAccess(req, res, next) {
    console.log('üîç Controllo privilegi admin...');
    
    if (!req.session || !req.session.user) {
        console.log('‚ùå Nessuna sessione attiva');
        return res.status(401).json({
            success: false,
            message: 'Accesso negato - Login richiesto'
        });
    }
    
    const user = req.session.user;
    const hasAdminAccess = user.ruolo === 'admin' || user.admin_access === true;
    
    if (!hasAdminAccess) {
        console.log('‚ùå Utente senza privilegi admin:', user.username);
        return res.status(403).json({
            success: false,
            message: 'Accesso negato - Privilegi admin richiesti'
        });
    }
    
    console.log('‚úÖ Accesso admin autorizzato per:', user.username);
    next();
}

// ========== API ADMIN/FRATELLI ==========

// POST /api/admin/fratelli - Crea fratello (SOLO ADMIN)
app.post('/api/admin/fratelli', requireAdminAccess, async (req, res) => {
    try {
        console.log('üë• ADMIN: Creazione nuovo fratello');
        console.log('üì• Dati ricevuti:', req.body);
        
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        if (!nome || !grado) {
            return res.status(400).json({
                success: false,
                message: 'Nome e grado sono obbligatori'
            });
        }
        
        // Inizio transazione esplicita
        await db.executeQuery('START TRANSACTION');
        
        try {
            const result = await db.addFratello(nome, grado, cariche, cariche_fisse);
            
            // Commit esplicito
            await db.executeQuery('COMMIT');
            console.log('‚úÖ Fratello creato con ID:', result.insertId);
            
            // Verifica che sia stato salvato
            const verifica = await db.getFratelloById(result.insertId);
            
            if (!verifica) {
                throw new Error('Fratello non trovato dopo il salvataggio');
            }
            
            res.status(201).json({
                success: true,
                message: 'Fratello creato con successo',
                data: {
                    id: result.insertId,
                    nome,
                    grado,
                    cariche,
                    cariche_fisse
                }
            });
            
        } catch (dbError) {
            await db.executeQuery('ROLLBACK');
            throw dbError;
        }
        
    } catch (error) {
        console.error('‚ùå Errore creazione fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nella creazione del fratello: ' + error.message,
            error: error.message
        });
    }
});

// PUT /api/admin/fratelli/:id - Aggiorna fratello (SOLO ADMIN)
app.put('/api/admin/fratelli/:id', requireAdminAccess, async (req, res) => {
    try {
        console.log('üë• ADMIN: Aggiornamento fratello ID:', req.params.id);
        
        const { id } = req.params;
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        const fratelloEsistente = await db.getFratelloById(id);
        if (!fratelloEsistente) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        await db.updateFratello(id, nome, grado, cariche, cariche_fisse);
        
        console.log('‚úÖ Fratello aggiornato con successo');
        
        res.json({
            success: true,
            message: 'Fratello aggiornato con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore aggiornamento fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'aggiornamento del fratello: ' + error.message,
            error: error.message
        });
    }
});

// ========== API ADMIN/TORNATE ==========

// POST /api/admin/tornate - Crea tornata (SOLO ADMIN)
app.post('/api/admin/tornate', requireAdminAccess, async (req, res) => {
    try {
        console.log('üìÖ ADMIN: Creazione nuova tornata');
        console.log('üì• Dati ricevuti:', req.body);
        
        // Validazione dati
        const { data, discussione, location } = req.body;
        
        if (!data) {
            return res.status(400).json({
                success: false,
                message: 'Data obbligatoria'
            });
        }
        
        // Prepara dati con nomi corretti
        const tornataData = {
            data: data,
            orario_inizio: req.body.orario_inizio || null,
            discussione: discussione || 'Nuova Tornata',
            chi_introduce: req.body.chi_introduce || null,
            location: location || 'Tolfa',
            cena: req.body.cena === true || req.body.cena === 'true',
            costo_cena: req.body.costo_cena || null,
            descrizione_cena: req.body.descrizione_cena || null,
            argomento_istruzione: req.body.argomento_istruzione || null,
            orario_istruzione: req.body.orario_istruzione || null,
            link_audio: req.body.link_audio || null,
            link_pagina: req.body.link_pagina || null,
            tipo_loggia: req.body.tipo_loggia || 'nostra',
            tipo: req.body.tipo || 'ordinaria',
            stato: req.body.stato || 'programmata',
            note: req.body.note || null
        };
        
        console.log('üìã Dati preparati per database:', tornataData);
        
        // Inizio transazione esplicita
        await db.executeQuery('START TRANSACTION');
        
        try {
            const result = await db.addTornata(tornataData);
            console.log('üìä Risultato INSERT:', result);
            
            // Commit esplicito
            await db.executeQuery('COMMIT');
            console.log('‚úÖ COMMIT completato');
            
            // Verifica immediata
            const verifica = await db.executeQuery('SELECT * FROM tornate WHERE id = ?', [result.insertId]);
            console.log('üîç VERIFICA POST-COMMIT:', verifica.length > 0 ? 'TROVATA' : 'NON TROVATA');
            
            if (result.insertId && verifica.length > 0) {
                console.log('üéâ SUCCESSO COMPLETO! ID:', result.insertId);
                
                res.status(201).json({
                    success: true,
                    message: 'Tornata creata e salvata con successo',
                    data: { 
                        id: result.insertId,
                        ...verifica[0]
                    }
                });
            } else {
                throw new Error('Tornata non trovata dopo il commit');
            }
            
        } catch (dbError) {
            console.log('üí• ERRORE - ROLLBACK...');
            await db.executeQuery('ROLLBACK');
            throw dbError;
        }
        
    } catch (error) {
        console.error('üí• ERRORE CRITICO ADMIN TORNATE:', error);
        
        res.status(500).json({
            success: false,
            message: 'Errore nella creazione: ' + error.message,
            error: error.code || error.message
        });
    }
});

console.log('‚úÖ API ADMIN protette caricate correttamente');

// ========== AGGIUNGI QUESTE API AL TUO server.js ==========
// Inserisci dopo l'API POST /api/admin/tornate (intorno alla riga 700)

// PUT /api/admin/tornate/:id - Aggiorna tornata (SOLO ADMIN)
app.put('/api/admin/tornate/:id', requireAdminAccess, async (req, res) => {
    try {
        console.log('üìÖ ADMIN: Aggiornamento tornata ID:', req.params.id);
        console.log('üì• Dati ricevuti:', req.body);
        
        const { id } = req.params;
        
        // Verifica che la tornata esista
        const tornataEsistente = await db.executeQuery('SELECT * FROM tornate WHERE id = ?', [id]);
        if (tornataEsistente.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Tornata non trovata'
            });
        }
        
        // Prepara dati per l'aggiornamento
        const tornataData = {
            data: req.body.data,
            orario_inizio: req.body.orario_inizio || null,
            discussione: req.body.discussione || 'Tornata',
            chi_introduce: req.body.chi_introduce || null,
            location: req.body.location || 'Tolfa',
            cena: req.body.cena === true || req.body.cena === 'true',
            costo_cena: req.body.costo_cena || null,
            descrizione_cena: req.body.descrizione_cena || null,
            argomento_istruzione: req.body.argomento_istruzione || null,
            orario_istruzione: req.body.orario_istruzione || null,
            link_audio: req.body.link_audio || null,
            link_pagina: req.body.link_pagina || null,
            tipo_loggia: req.body.tipo_loggia || 'nostra',
            tipo: req.body.tipo || 'ordinaria',
            stato: req.body.stato || 'programmata',
            note: req.body.note || null
        };
        
        console.log('üìã Dati preparati per aggiornamento:', tornataData);
        
        // Inizio transazione esplicita
        await db.executeQuery('START TRANSACTION');
        
        try {
            const result = await db.updateTornata(id, tornataData);
            console.log('üìä Risultato UPDATE:', result);
            
            // Commit esplicito
            await db.executeQuery('COMMIT');
            console.log('‚úÖ COMMIT completato');
            
            // Verifica immediata
            const verifica = await db.executeQuery('SELECT * FROM tornate WHERE id = ?', [id]);
            console.log('üîç VERIFICA POST-COMMIT:', verifica.length > 0 ? 'TROVATA' : 'NON TROVATA');
            
            if (verifica.length > 0) {
                console.log('üéâ AGGIORNAMENTO COMPLETATO! ID:', id);
                
                res.json({
                    success: true,
                    message: 'Tornata aggiornata con successo',
                    data: verifica[0]
                });
            } else {
                throw new Error('Tornata non trovata dopo l\'aggiornamento');
            }
            
        } catch (dbError) {
            console.log('üí• ERRORE - ROLLBACK...');
            await db.executeQuery('ROLLBACK');
            throw dbError;
        }
        
    } catch (error) {
        console.error('üí• ERRORE CRITICO ADMIN TORNATE UPDATE:', error);
        
        res.status(500).json({
            success: false,
            message: 'Errore nell\'aggiornamento: ' + error.message,
            error: error.code || error.message
        });
    }
});

// DELETE /api/admin/tornate/:id - Elimina tornata (SOLO ADMIN)
app.delete('/api/admin/tornate/:id', requireAdminAccess, async (req, res) => {
    try {
        console.log('üìÖ ADMIN: Eliminazione tornata ID:', req.params.id);
        
        const { id } = req.params;
        
        // Verifica che la tornata esista
        const tornata = await db.executeQuery('SELECT * FROM tornate WHERE id = ?', [id]);
        if (tornata.length === 0) {
            return res.status(404).json({
                success: false,
                message: 'Tornata non trovata'
            });
        }
        
        // Elimina prima le presenze collegate
        await db.executeQuery('DELETE FROM presenze WHERE tornata_id = ?', [id]);
        console.log('‚úÖ Presenze collegate eliminate');
        
        // Elimina la tornata
        const result = await db.executeQuery('DELETE FROM tornate WHERE id = ?', [id]);
        console.log('‚úÖ Tornata eliminata:', result);
        
        if (result.affectedRows === 0) {
            throw new Error('Nessuna riga eliminata');
        }
        
        res.json({
            success: true,
            message: 'Tornata eliminata con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore eliminazione tornata:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'eliminazione della tornata: ' + error.message,
            error: error.message
        });
    }
});

console.log('‚úÖ API ADMIN TORNATE (PUT/DELETE) caricate correttamente');
// ========== API ADMIN/FRATELLI ==========

// POST /api/admin/fratelli - Crea fratello (SOLO ADMIN)
app.post('/api/admin/fratelli', requireAdminAccess, async (req, res) => {
    try {
        console.log('üë• ADMIN: Creazione nuovo fratello');
        console.log('üì• Dati ricevuti:', req.body);
        
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        if (!nome || !grado) {
            return res.status(400).json({
                success: false,
                message: 'Nome e grado sono obbligatori'
            });
        }
        
        // Inizio transazione esplicita
        await db.executeQuery('START TRANSACTION');
        
        try {
            const result = await db.addFratello(nome, grado, cariche, cariche_fisse);
            
            // Commit esplicito
            await db.executeQuery('COMMIT');
            console.log('‚úÖ Fratello creato con ID:', result.insertId);
            
            // Verifica che sia stato salvato
            const verifica = await db.getFratelloById(result.insertId);
            
            if (!verifica) {
                throw new Error('Fratello non trovato dopo il salvataggio');
            }
            
            res.status(201).json({
                success: true,
                message: 'Fratello creato con successo',
                data: {
                    id: result.insertId,
                    nome,
                    grado,
                    cariche,
                    cariche_fisse
                }
            });
            
        } catch (dbError) {
            await db.executeQuery('ROLLBACK');
            throw dbError;
        }
        
    } catch (error) {
        console.error('‚ùå Errore creazione fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nella creazione del fratello: ' + error.message,
            error: error.message
        });
    }
});

// PUT /api/admin/fratelli/:id - Aggiorna fratello (SOLO ADMIN)
app.put('/api/admin/fratelli/:id', requireAdminAccess, async (req, res) => {
    try {
        console.log('üë• ADMIN: Aggiornamento fratello ID:', req.params.id);
        
        const { id } = req.params;
        const { nome, grado, cariche = null, cariche_fisse = null } = req.body;
        
        const fratelloEsistente = await db.getFratelloById(id);
        if (!fratelloEsistente) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        await db.updateFratello(id, nome, grado, cariche, cariche_fisse);
        
        console.log('‚úÖ Fratello aggiornato con successo');
        
        res.json({
            success: true,
            message: 'Fratello aggiornato con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore aggiornamento fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'aggiornamento del fratello: ' + error.message,
            error: error.message
        });
    }
});

// DELETE /api/admin/fratelli/:id - Elimina fratello (SOLO ADMIN)
app.delete('/api/admin/fratelli/:id', requireAdminAccess, async (req, res) => {
    try {
        console.log('üë• ADMIN: Eliminazione fratello ID:', req.params.id);
        
        const { id } = req.params;
        
        const fratello = await db.getFratelloById(id);
        if (!fratello) {
            return res.status(404).json({
                success: false,
                message: 'Fratello non trovato'
            });
        }
        
        await db.deleteFratello(id);
        
        console.log('‚úÖ Fratello eliminato con successo');
        
        res.json({
            success: true,
            message: 'Fratello eliminato con successo'
        });
        
    } catch (error) {
        console.error('‚ùå Errore eliminazione fratello:', error);
        res.status(500).json({
            success: false,
            message: 'Errore nell\'eliminazione del fratello: ' + error.message,
            error: error.message
        });
    }
});

// ========== API ADMIN/TORNATE ==========

// POST /api/admin/tornate - Crea tornata (SOLO ADMIN)
app.post('/api/admin/tornate', requireAdminAccess, async (req, res) => {
    try {
        console.log('üìÖ ADMIN: Creazione nuova tornata');
        console.log('üì• Dati ricevuti:', req.body);
        
        // Validazione dati
        const { data, discussione, location } = req.body;
        
        if (!data) {
            return res.status(400).json({
                success: false,
                message: 'Data obbligatoria'
            });
        }
        
        // Prepara dati con nomi corretti
        const tornataData = {
            data: data,
            orario_inizio: req.body.orario_inizio || null,
            discussione: discussione || 'Nuova Tornata',
            chi_introduce: req.body.chi_introduce || null,
            location: location || 'Tolfa',
            cena: req.body.cena === true || req.body.cena === 'true',
            costo_cena: req.body.costo_cena || null,
            descrizione_cena: req.body.descrizione_cena || null,
            argomento_istruzione: req.body.argomento_istruzione || null,
            orario_istruzione: req.body.orario_istruzione || null,
            link_audio: req.body.link_audio || null,
            link_pagina: req.body.link_pagina || null,
            tipo_loggia: req.body.tipo_loggia || 'nostra',
            tipo: req.body.tipo || 'ordinaria',
            stato: req.body.stato || 'programmata',
            note: req.body.note || null
        };
        
        console.log('üìã Dati preparati per database:', tornataData);
        
        // Inizio transazione esplicita
        await db.executeQuery('START TRANSACTION');
        
        try {
            const result = await db.addTornata(tornataData);
            console.log('üìä Risultato INSERT:', result);
            
            // Commit esplicito
            await db.executeQuery('COMMIT');
            console.log('‚úÖ COMMIT completato');
            
            // Verifica immediata
            const verifica = await db.executeQuery('SELECT * FROM tornate WHERE id = ?', [result.insertId]);
            console.log('üîç VERIFICA POST-COMMIT:', verifica.length > 0 ? 'TROVATA' : 'NON TROVATA');
            
            if (result.insertId && verifica.length > 0) {
                console.log('üéâ SUCCESSO COMPLETO! ID:', result.insertId);
                
                res.status(201).json({
                    success: true,
                    message: 'Tornata creata e salvata con successo',
                    data: { 
                        id: result.insertId,
                        ...verifica[0]
                    }
                });
            } else {
                throw new Error('Tornata non trovata dopo il commit');
            }
            
        } catch (dbError) {
            console.log('üí• ERRORE - ROLLBACK...');
            await db.executeQuery('ROLLBACK');
            throw dbError;
        }
        
    } catch (error) {
        console.error('üí• ERRORE CRITICO ADMIN TORNATE:', error);
        
        res.status(500).json({
            success: false,
            message: 'Errore nella creazione: ' + error.message,
            error: error.code || error.message
        });
    }
});

console.log('‚úÖ API ADMIN protette caricate correttamente');

// ========== ROTTE AREA FRATELLI (HTML) ==========
app.get('/fratelli/login', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/login.html'));
});

app.get('/fratelli/dashboard', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/dashboard.html'));
});

app.get('/fratelli/tornate', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/tornate.html'));
});

app.get('/fratelli/lavori', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/lavori.html'));
});

app.get('/fratelli/presenze', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/presenze.html'));
});

app.get('/fratelli/profilo', (req, res) => {
    res.sendFile(path.join(__dirname, 'views/fratelli/profilo.html'));
});

// ========== API STATUS E TEST ==========
app.get('/api/status', async (req, res) => {
    const dbStatus = await testConnection();
    res.json({ 
        status: 'online', 
        app: 'Presenze Kilwinning',
        version: '1.0.0',
        database: dbStatus ? 'connesso' : 'disconnesso',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development'
    });
});

app.get('/api/test', (req, res) => {
    res.json({ 
        message: 'Server funzionante!',
        environment: process.env.NODE_ENV || 'development',
        database_configured: !!(process.env.DB_HOST && process.env.DB_NAME),
        routes_loaded: {
            admin: '‚úÖ (NO LOGIN SEPARATO)',
            fratelli: '‚úÖ (CON PRIVILEGI ADMIN)', 
            presenze: '‚úÖ',
            tornate: '‚úÖ'
        }
    });
});

// ========== HOMEPAGE CORRETTA ==========
app.get('/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html lang="it">
        <head>
            <title>R‚à¥L‚à¥ Kilwinning - Sistema Gestione Tornate</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                }
                
                .container {
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.15);
                    width: 100%;
                    max-width: 500px;
                    text-align: center;
                }
                
                .logo {
                    font-size: 3rem;
                    margin-bottom: 15px;
                }
                
                .title {
                    font-size: 28px;
                    font-weight: bold;
                    color: #333;
                    margin-bottom: 8px;
                }
                
                .subtitle {
                    color: #666;
                    margin-bottom: 35px;
                    font-size: 16px;
                }
                
                .access-title {
                    font-size: 20px;
                    font-weight: 600;
                    color: #333;
                    margin-bottom: 25px;
                }
                
                .access-options {
                    display: grid;
                    grid-template-columns: 1fr;
                    gap: 20px;
                    margin-bottom: 30px;
                }
                
                .access-card {
                    padding: 25px 20px;
                    border: 2px solid #e9ecef;
                    border-radius: 15px;
                    text-decoration: none;
                    color: #333;
                    transition: all 0.3s;
                    background: #f8f9fa;
                }
                
                .access-card:hover {
                    border-color: #667eea;
                    background: #f0f4ff;
                    transform: translateY(-3px);
                    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
                }
                
                .access-icon {
                    font-size: 2.5rem;
                    margin-bottom: 15px;
                    display: block;
                }
                
                .access-label {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 8px;
                    color: #333;
                }
                
                .access-description {
                    font-size: 14px;
                    color: #666;
                }
                
                .admin-note {
                    font-size: 12px;
                    color: #888;
                    font-style: italic;
                    margin-top: 10px;
                }
                
                .footer {
                    padding-top: 25px;
                    border-top: 1px solid #e9ecef;
                    color: #999;
                    font-size: 14px;
                }
                
                @media (max-width: 480px) {
                    .container {
                        padding: 30px 25px;
                        margin: 10px;
                    }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="logo">üèõÔ∏è</div>
                <h1 class="title">R‚à¥L‚à¥ Kilwinning</h1>
                <p class="subtitle">Sistema Gestione Tornate</p>
                
                <h2 class="access-title">Accesso Fratelli</h2>
                
                <div class="access-options">
                    <a href="/fratelli/login" class="access-card">
                        <span class="access-icon">üë•</span>
                        <div class="access-label">Area Fratelli</div>
                        <div class="access-description">Accesso unificato per tutti i fratelli</div>
                        <div class="admin-note">
                            ‚ú® Paolo e Emiliano avranno accesso automatico all'area amministrativa
                        </div>
                    </a>
                </div>
                
                <div class="footer">
                    ¬© 2025 R‚à¥L‚à¥ Kilwinning<br>
                    Sistema di gestione presenze e tornate<br>
                    <strong>‚úÖ Login amministrativo integrato</strong>
                </div>
            </div>
        </body>
        </html>
    `);
});

// ========== MIDDLEWARE DI ERROR HANDLING ==========
app.use((err, req, res, next) => {
    console.error('üí• Errore middleware:', err);
    res.status(500).json({
        success: false,
        message: 'Errore interno del server',
        error: process.env.NODE_ENV === 'development' ? err.message : 'Errore generico'
    });
});

// ========== 404 HANDLER ==========
app.get('*', (req, res) => {
    console.log(`‚ùå 404 - Rotta non trovata: ${req.method} ${req.path}`);
    res.status(404).json({
        success: false,
        message: '404 - Endpoint non trovato',
        path: req.path,
        method: req.method
    });
});

// ========== AVVIO SERVER ==========
(async () => {
    try {
        console.log('üöÄ Avvio server Kilwinning...');
        
        // Test connessione database
        const dbOk = await testConnection();
        if (!dbOk) {
            throw new Error('‚ùå Connessione al database fallita - Verificare le credenziali');
        }
        console.log('‚úÖ Database connesso correttamente');

        const PORT = process.env.PORT || 3000;

        app.listen(PORT, () => {
            console.log(`
üèõÔ∏è =====================================
   SERVER PRESENZE KILWINNING ONLINE!
   =====================================
   üåê URL: http://localhost:${PORT}
   üìç Ambiente: ${process.env.NODE_ENV || 'development'}
   üóÑÔ∏è Database: ${process.env.DB_NAME || 'non configurato'}
   ‚è∞ Avvio: ${new Date().toLocaleString('it-IT')}
   
   ‚úÖ MODIFICHE APPLICATE:
   ‚Ä¢ ‚ùå Rimosso login admin separato
   ‚Ä¢ ‚úÖ Admin integrato nell'area fratelli
   ‚Ä¢ ‚úÖ Paolo e Emiliano = privilegi admin automatici
   ‚Ä¢ ‚úÖ Homepage semplificata con un solo accesso
   ‚Ä¢ üîß RISOLTO ERRORE 503!
   =====================================
            `);
        });

    } catch (err) {
        console.error(`
üí• =====================================
   ERRORE CRITICO DURANTE L'AVVIO!
   =====================================
   ${err.message}
   =====================================
        `);
        process.exit(1);
    }
})();