<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Riservata - Loggia Kilwinning</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0f3460">

    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tornate">

    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png">

    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">

    <!-- Android/Chrome -->
    <meta name="mobile-web-app-capable" content="yes">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
html {
    min-height: 100%;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
    display: flex;
    flex-direction: column;
    /* AGGIUNGI QUESTO per mobile: */
    background-attachment: scroll; /* Invece di fixed */
}
        
        .main-content {
            flex: 1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
        }
        
        .user-details h2 {
            color: #333;
            margin-bottom: 5px;
            font-size: 24px;
        }
        
        .user-details p {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .user-ruolo {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        
        /* Menu Navigazione Principale */
        .main-navigation {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .nav-card {
            background: white;
            border-radius: 15px;
            padding: 30px 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: visible;
        }

        .nav-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .nav-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.25);
        }

        .nav-card:hover::before {
            transform: scaleX(1);
        }

        .nav-icon {
            font-size: 3rem;
            line-height: 1;
        }

        .nav-label {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #e94560 0%, #d63447 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(233, 69, 96, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Responsive per mobile */
        @media (max-width: 768px) {
            .main-navigation {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .nav-card {
                padding: 25px 15px;
            }

            .nav-icon {
                font-size: 2.5rem;
            }

            .nav-label {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .nav-card {
                padding: 20px 10px;
            }

            .nav-icon {
                font-size: 2rem;
            }

            .nav-label {
                font-size: 14px;
            }
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-admin { background: #6f42c1; color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Bottoni Header Actions */
        .header-actions {
            display: flex !important;
            gap: 10px;
            align-items: center;
            flex-shrink: 0; /* Impedisce che si comprima */
        }

        .header-actions .btn {
            font-size: 13px;
            padding: 8px 16px;
        }

        /* Action Buttons Section - Nuova sezione dedicata */
        .action-buttons-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-buttons-section .btn {
            font-size: 14px;
            padding: 12px 24px;
            min-width: 140px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .stat-label {
            color: #666;
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .stat-sublabel {
            color: #999;
            font-size: 12px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .card-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        .tornata-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border: 2px solid #f1f3f4;
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: #fafafa;
        }
        
        .tornata-item:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .tornata-info {
            flex: 1;
        }
        
        .tornata-data {
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
            font-size: 16px;
        }
        
        .tornata-titolo {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 15px;
        }
        
        .tornata-dettagli {
            font-size: 14px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .tornata-badge {
            background: #e9ecef;
            color: #495057;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .tornata-badge.ordinaria { background: #cce5ff; color: #0056b3; }
        .tornata-badge.cerimonia { background: #fff3cd; color: #856404; }
        .tornata-badge.straordinaria { background: #f8d7da; color: #721c24; }
        
        .presenza-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
            min-width: 140px;
        }
        
        .presenza-status {
            display: flex;
            gap: 8px;
        }
        
        .presenza-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 110px;
            position: relative;
            overflow: visible;
        }

        .presenza-btn.presente {
            background: #28a745;
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .presenza-btn.presente:hover:not(.confermato) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .presenza-btn.assente {
            background: #dc3545;
            color: white;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .presenza-btn.assente:hover:not(.confermato) {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .presenza-btn.pending {
            background: #ffc107;
            color: #212529;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .presenza-btn.confermato {
            opacity: 0.9;
            cursor: default;
            position: relative;
            padding-right: 35px;
        }

        .presenza-btn.confermato::after {
            content: '‚úì';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: bold;
            font-size: 16px;
        }
        
        .presenza-status-text {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px dashed #dee2e6;
        }
        
        .no-data-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* FOOTER STYLES MIGLIORATI */
        .footer {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4c93 100%);
            color: white;
            padding: 40px 0 25px 0;
            margin-top: 30px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }
        
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 35px;
            margin-bottom: 30px;
        }
        
        .footer-section h4 {
            color: #fff;
            margin-bottom: 18px;
            font-size: 17px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            padding-bottom: 10px;
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .footer-section li {
            margin-bottom: 12px;
        }
        
        .footer-section a {
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            border-radius: 4px;
        }
        
        .footer-section a:hover {
            color: #fff;
            transform: translateX(8px);
            background: rgba(255,255,255,0.1);
            padding-left: 10px;
        }
        
        .footer-section span {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
        }
        
        .footer-bottom {
            border-top: 1px solid rgba(255,255,255,0.15);
            padding-top: 25px;
            text-align: center;
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }
        
        .footer-bottom small {
            font-size: 12px;
            color: rgba(255,255,255,0.6);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .footer {
                padding: 30px 0 20px 0;
            }
            
            .footer-grid {
                grid-template-columns: 1fr;
                gap: 25px;
            }
            
            .footer-section h4 {
                font-size: 16px;
                margin-bottom: 15px;
            }
            
            .footer-section a:hover {
                transform: none;
                padding-left: 5px;
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons-section {
                flex-direction: column;
            }
            
            .action-buttons-section .btn {
                width: 100%;
                max-width: 300px;
            }

            .header {
                flex-direction: column;
                text-align: center;
            }

            .header-actions {
                display: flex !important; /* Mantieni visibile anche su mobile */
                justify-content: center;
                width: 100%;
                margin-top: 15px;
            }

            .header-actions .btn {
                flex: 1;
                max-width: 150px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tornata-item {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .user-info {
                flex-direction: column;
                text-align: center;
            }

            .presenza-controls {
                width: 100%;
            }

            .presenza-status {
                justify-content: center;
            }

            .tornata-dettagli {
                justify-content: center;
            }

            .footer {
                padding: 25px 0 15px 0;
            }

            .footer-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">Caricamento...</h2>
                        <p id="userInfo">Verificando accesso...</p>
                        <span class="user-ruolo" id="userRuolo">Caricamento ruolo...</span>
                    </div>
                </div>
            </div>

            <!-- NUOVA SEZIONE: Bottoni Admin/Esci -->
            <div class="action-buttons-section">
                <button id="adminHeaderBtn" class="btn btn-admin" onclick="accessoAdmin()" style="display: none;">
                    üîß Admin
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    üö™ Esci
                </button>
            </div>

            <!-- Statistiche Personali -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üèõÔ∏è</div>
                    <div class="stat-number" id="statRuolo">-</div>
                    <div class="stat-label">Ruolo in Loggia</div>
                    <div class="stat-sublabel">Carica istituzionale</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-number" id="statPresenze">-%</div>
                    <div class="stat-label">Presenze 2025</div>
                    <div class="stat-sublabel" id="statPresenzeDettaglio">- tornate su -</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-number" id="statTornate">-</div>
                    <div class="stat-label">Tornate Partecipate</div>
                    <div class="stat-sublabel">Anno corrente</div>
                </div>
            </div>

            <!-- Menu Navigazione Principale -->
            <div class="main-navigation">
                <a href="/fratelli/tornate" class="nav-card">
                    <div class="nav-icon">üìÖ</div>
                    <div class="nav-label">Tornate</div>
                </a>
                <a href="/fratelli/presenze" class="nav-card">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">Presenze</div>
                </a>
                <a href="/fratelli/tavole" class="nav-card">
                    <div class="nav-icon">üìö</div>
                    <div class="nav-label">Tavole</div>
                </a>
                <a href="#" onclick="apriBiblioteca(); return false;" class="nav-card">
                    <div class="nav-icon">üìñ</div>
                    <div class="nav-label">Biblioteca</div>
                </a>
                <a href="#" onclick="apriFinanze(); return false;" class="nav-card">
                    <div class="nav-icon">üí∞</div>
                    <div class="nav-label">Finanze</div>
                </a>
                <a href="/fratelli/chat" class="nav-card nav-card-new">
                    <div class="nav-icon">üí¨</div>
                    <div class="nav-label">Chat</div>
                    <div class="new-badge">NUOVO</div>
                </a>
            </div>

            <!-- Alert Area -->
            <div id="alertContainer"></div>

            <!-- Prossime Tornate -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìÖ Prossime Tornate</h3>
                    <a href="/fratelli/tornate" class="btn btn-primary" style="font-size: 12px; padding: 6px 12px;">Vedi Tutte</a>
                </div>
                
                <div id="tornateContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        Caricamento prossime tornate...
                    </div>
                </div>
            </div>

            <!-- Informazioni Loggia -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">‚ÑπÔ∏è Informazioni Loggia</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div>
                        <h4 style="color: #333; margin-bottom: 10px;">üìç Sede della Loggia</h4>
                        <p style="color: #666; line-height: 1.6;">
                            R‚à¥L‚à¥ Kilwinning<br>
                            üìç Via XX Settembre, 22 - Tolfa (RM)<br>
                            üìß segreteria@loggiakilwinning.com
                        </p>
                    </div>
                    
                    <div>
                        <h4 style="color: #333; margin-bottom: 10px;">‚è∞ Calendario Tornate</h4>
                        <p style="color: #666; line-height: 1.6;">
                            üóìÔ∏è Secondo marted√¨ del mese<br>
                            üóìÔ∏è Quarto gioved√¨ del mese<br>
                            üï∞Ô∏è Inizio Lavori: ore 19:30<br>
                            üìß Conferme: entro 5 giorni dalla tornata
                        </p>
                    </div>
                    
                    <div>
                        <h4 style="color: #333; margin-bottom: 10px;">üë• Loggia Kilwinning</h4>
                        <p style="color: #666; line-height: 1.6;">
                            üìä 22 fratelli attivi<br>
                            üéØ 15 cariche istituzionali<br>
                            üìà 86% presenza media 2025<br>
                            üèõÔ∏è Oriente di Tolfa (RM)
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- FOOTER CORRETTO -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-grid">
                <!-- Sito Principale -->
                <div class="footer-section">
                    <h4>üåê Sito Ufficiale</h4>
                    <ul>
                        <li><a href="https://loggiakilwinning.com" target="_blank">üèõÔ∏è Loggia Kilwinning</a></li>
                        <li><a href="https://finanze.loggiakilwinning.com" target="_blank">üí∞ Area Finanze</a></li>
                        <li><a href="https://loggiakilwinning.com/category/tavole/" target="_blank">üìö Tavole Architettoniche</a></li>
                        <li><a href="https://loggiakilwinning.com/category/approfondimenti/" target="_blank">üìñ Approfondimenti</a></li>
                    </ul>
                </div>
                
                <!-- Sistema Gestionale -->
                <div class="footer-section">
                    <h4>‚öôÔ∏è Sistema Gestionale</h4>
                    <ul>
                        <li><a href="/fratelli/tornate">üìÖ Calendario Tornate</a></li>
                        <li><a href="/fratelli/presenze">üìä Le Mie Presenze</a></li>
                        <li><a href="/fratelli/tavole">üìö Archivio Tavole</a></li>
                        <li><a href="/fratelli/riepilogo-fratelli">üë• Riepilogo Fratelli</a></li>
                        <li id="adminFooterLink" style="display: none;"><a href="/admin/dashboard">üîß Admin</a></li>
                    </ul>
                </div>

                <!-- Info e Supporto -->
                <div class="footer-section">
                    <h4>‚ÑπÔ∏è Informazioni</h4>
                    <ul>
                        <li><a href="#" onclick="logout(); return false;">üö™ Esci</a></li>
                        <li><a href="mailto:segreteria@loggiakilwinning.com">üìß Supporto Tecnico</a></li>
                        <li><span style="color: rgba(255,255,255,0.6); font-size: 13px;">üíæ Sistema v2.1</span></li>
                        <li><span id="lastUpdate" style="color: rgba(255,255,255,0.6); font-size: 13px;">‚è±Ô∏è Aggiornato: --:--</span></li>
                    </ul>
                </div>
            </div>
            
            <!-- Footer Bottom -->
            <div class="footer-bottom">
                <p>¬© 2025 R‚à¥L‚à¥ Kilwinning - Oriente di Tolfa (RM)<br>
                <small>Sistema di gestione presenze e tornate</small></p>
            </div>
        </div>
    </footer>
<script src="/js/error-manager.js"></script>
    <script>
        // Dati fratello autenticato
        let fratelliAuth = null;

        // ID dei fratelli che hanno accesso admin
        const ADMIN_USERS = [16, 12]; // Paolo Giulio Gazzano (16), Emiliano Menicucci (12)

        // ‚úÖ Configurazione timeout sessione (10 minuti)
        const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minuti in millisecondi
        const WARNING_TIME = 9 * 60 * 1000; // Avviso a 9 minuti (1 minuto prima della scadenza)
        let sessionTimer = null;
        let warningTimer = null;
        let lastActivityTime = Date.now();

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadFratelliData();
            updateLastUpdate();
            initSessionMonitoring(); // ‚úÖ Inizializza monitoraggio sessione
        });

        // Aggiorna timestamp ultimo aggiornamento
        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').innerHTML = `‚è±Ô∏è Aggiornato: ${timeString}`;
        }

        // Verifica autenticazione
        function checkAuth() {
            const authData = sessionStorage.getItem('fratelliAuth');
            
            if (!authData) {
                window.location.href = '/fratelli/login';
                return;
            }
            
            try {
                fratelliAuth = JSON.parse(authData);
                setupUserInterface();
            } catch (error) {
                console.error('Errore parsing auth data:', error);
                logout();
            }
        }

        // Setup interfaccia utente
        function setupUserInterface() {
            if (!fratelliAuth) return;

            // Aggiorna header
            document.getElementById('userAvatar').textContent = fratelliAuth.nome.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = fratelliAuth.nome;
            
            let userInfoText = `${fratelliAuth.grado}`;
            if (fratelliAuth.ruolo) {
                userInfoText += ` ‚Ä¢ Loggia Kilwinning`;
            }
            document.getElementById('userInfo').textContent = userInfoText;
            
            // Mostra ruolo correttamente
            const ruoloText = fratelliAuth.ruolo || 'Fratello di Loggia';
            document.getElementById('userRuolo').textContent = ruoloText;
            document.getElementById('statRuolo').textContent = ruoloText;

            // Setup accesso admin
            setupAdminAccess();

            // Mostra benvenuto
            showAlert(`üèõÔ∏è Benvenuto, Fr‚à¥ ${fratelliAuth.nome}!`, 'success');
        }

        // Setup accesso admin
        function setupAdminAccess() {
            const userId = parseInt(fratelliAuth.id);
            
            console.log('üîç Setup Admin Access - User ID:', userId);
            console.log('üìã ADMIN_USERS:', ADMIN_USERS);
            console.log('‚úÖ Is Admin?', ADMIN_USERS.includes(userId));

            if (ADMIN_USERS.includes(userId)) {
                // Mostra link admin nel footer
                document.getElementById('adminFooterLink').style.display = 'block';

                // ‚úÖ NUOVO: Mostra bottone Admin nell'header
                const adminHeaderBtn = document.getElementById('adminHeaderBtn');
                console.log('üîò Admin Button Element:', adminHeaderBtn);
                
                if (adminHeaderBtn) {
                    adminHeaderBtn.style.display = 'inline-flex';
                    console.log('‚úÖ Admin button display set to inline-flex');
                } else {
                    console.error('‚ùå Admin button element NOT FOUND');
                }

                // Crea sessione admin silenziosa
                createAdminSession();
            }
            
            // Verifica che il bottone Esci sia visibile
            const exitBtn = document.querySelector('.header-actions .btn-danger');
            console.log('üö™ Exit Button Element:', exitBtn);
            console.log('üö™ Exit Button Visible:', exitBtn ? window.getComputedStyle(exitBtn).display : 'NOT FOUND');
        }

        // Crea sessione admin nel server
        async function createAdminSession() {
            try {
                const response = await fetch('/api/fratelli/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome: fratelliAuth.nome })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Sessione admin creata:', result.admin_access);
                }
            } catch (error) {
                console.error('‚ùå Errore nella creazione sessione admin:', error);
            }
        }

        // Accesso admin
        function accessoAdmin() {
            const userId = parseInt(fratelliAuth.id);
            if (!ADMIN_USERS.includes(userId)) {
                alert('Non hai i privilegi per accedere all\'area amministrativa');
                return;
            }

            window.location.href = '/admin/dashboard';
        }

        /**
         * ‚úÖ NUOVO: Apre l'app Finanze con auto-login SSO
         */
        function apriFinanze() {
            if (!fratelliAuth) {
                alert('Errore: Sessione non valida');
                return;
            }

            const userId = parseInt(fratelliAuth.id);
            let username, password;

            // Paolo Giulio Gazzano = Admin
            if (userId === 16) {
                username = 'admin';
                password = 'admin123';
            } else {
                // Altri fratelli
                username = 'Fratello';
                password = 'puntorosso';
            }

            // Crea token SSO (valido 30 secondi)
            const ssoData = {
                username: username,
                password: password,
                timestamp: Date.now(),
                from: 'tornate',
                userId: userId,
                nome: fratelliAuth.nome
            };

            const token = btoa(JSON.stringify(ssoData));

            // Apri Finanze con token SSO
            const finanzeUrl = `https://finanze.loggiakilwinning.com/?sso=${token}`;
            window.open(finanzeUrl, '_blank');
        }

        /**
         * ‚úÖ NUOVO: Apre l'app Biblioteca con auto-login SSO
         */
        function apriBiblioteca() {
            if (!fratelliAuth) {
                alert('Errore: Sessione non valida');
                return;
            }

            // Per la biblioteca, tutti i fratelli usano il proprio nome
            const ssoData = {
                fratello_nome: fratelliAuth.nome,
                timestamp: Date.now(),
                from: 'tornate',
                userId: fratelliAuth.id
            };

            const token = btoa(JSON.stringify(ssoData));

            // Apri Biblioteca con token SSO
            const bibliotecaUrl = `https://biblioteca.loggiakilwinning.com/?sso=${token}`;
            window.open(bibliotecaUrl, '_blank');
        }

        // Carica dati fratello
        async function loadFratelliData() {
            if (!fratelliAuth) return;

            try {
                await Promise.all([
                    loadStatistiche(),
                    loadProssimeTornate()
                ]);
                
            } catch (error) {
                console.error('Errore caricamento dati:', error);
                showAlert('Errore nel caricamento dei dati', 'warning');
            }
        }

 // Carica statistiche personali
async function loadStatistiche() {
    try {
        // ‚úÖ FIX: Usa l'endpoint corretto per le statistiche
        const response = await fetch(`/api/presenze/fratello/${fratelliAuth.id}/statistiche?anno=2025`);
        if (response.ok) {
            const result = await response.json();
            const stats = result.data || result;
            
            // Assicurati che i campi esistano
            const percentuale = stats.percentuale || 0;
            const presenze = stats.presenzeCount || 0;
            const totali = stats.totaliTornate || 0;
            
            document.getElementById('statPresenze').textContent = Math.round(percentuale) + '%';
            document.getElementById('statPresenzeDettaglio').textContent = `${presenze} tornate su ${totali}`;
            document.getElementById('statTornate').textContent = presenze;
            
            console.log('‚úÖ Statistiche caricate:', { percentuale, presenze, totali });
            
        } else {
            console.error('‚ùå API statistiche ha restituito errore:', response.status);
            throw new Error('API statistiche non disponibile');
        }
    } catch (error) {
        console.error('‚ùå Errore caricamento statistiche:', error);
        // Dati di emergenza
        document.getElementById('statPresenze').textContent = '0%';
        document.getElementById('statPresenzeDettaglio').textContent = '0 tornate su 0';
        document.getElementById('statTornate').textContent = '0';
    }
}

        // Carica prossime tornate DAL DATABASE
        async function loadProssimeTornate() {
            try {
              const response = await fetch(`/api/tornate/prossime?fratello_id=${fratelliAuth.id}`);
                
                if (response.ok) {
                    const tornateAPI = await response.json();
                    
                   // üîß FIX FILTRO DATE - SOSTITUISCI NELLA DASHBOARD

// Filtra solo le future e prendi le prime 2
const oggi = new Date();
oggi.setHours(0, 0, 0, 0); // Reset ore per confronto corretto

console.log('üìÖ DEBUG: Data di oggi:', oggi.toISOString().split('T')[0]);

const tornateFuture = tornateAPI.filter(t => {
    const dataTornata = new Date(t.data + 'T00:00:00'); // Forza timezone locale
    dataTornata.setHours(0, 0, 0, 0);
    
    const isFutura = dataTornata > oggi; // Cambiato da >= a > per escludere oggi
   
console.log(`üìã Tornata ${t.id}: ${t.data} - Futura: ${isFutura}`);
    
    return isFutura; // ‚úÖ SOLO QUESTO FILTRO!
}).slice(0, 3); // ‚úÖ AUMENTA A 3 TORNATE
                    if (tornateFuture && tornateFuture.length > 0) {
                        renderTornate(tornateFuture);
                    } else {
                        renderNoTornate();
                    }
                } else {
                    await loadTornateFallback();
                }
                
            } catch (error) {
                console.error('‚ùå Errore caricamento tornate:', error);
                await loadTornateFallback();
            }
        }

        // Fallback con API fratelli
        async function loadTornateFallback() {
            try {
                const response = await fetch(`/api/fratelli/${fratelliAuth.id}/tornate?future=true&limit=2`);
                
                if (response.ok) {
                    const result = await response.json();
                    const tornate = result.data && result.data.tornate ? result.data.tornate : [];
                    
                    if (tornate.length > 0) {
                        renderTornate(tornate);
                    } else {
                        renderNoTornate();
                    }
                } else {
                    renderNoTornate();
                }
                
            } catch (error) {
                console.error('‚ùå Anche il fallback √® fallito:', error);
                renderNoTornate();
            }
        }

        // Renderizza le tornate reali
        function renderTornate(tornate) {
            const container = document.getElementById('tornateContainer');
            
            if (!container) {
                console.error('‚ùå Container tornateContainer non trovato!');
                return;
            }
            
            const tornateHTML = tornate.map(tornata => createTornataHTML(tornata)).join('');
            container.innerHTML = tornateHTML;
            
            console.log(`‚úÖ Renderizzate ${tornate.length} prossime tornate dal database`);
        }

        // Gestisce il caso "nessuna tornata"
        function renderNoTornate() {
            const container = document.getElementById('tornateContainer');
            
            container.innerHTML = `
                <div class="no-data">
                    <div class="no-data-icon">üìÖ</div>
                    <strong>Non ci sono in programma altre Tornate</strong>
                    <p style="margin-top: 10px; font-size: 14px;">
                        Controlla il calendario ufficiale o contatta il Segretario per informazioni.
                    </p>
                </div>
            `;
            
            console.log('üìÖ Nessuna tornata futura trovata nel database');
        }


// üé™ MODAL PRESENZE TORNATA - VERSIONE CORRETTA
// 1Ô∏è‚É£ FUNZIONE createTornataHTML con gestione apostrofi

function createTornataHTML(tornata) {
    const dataFormatted = formatDateItalian(tornata.data);
    const orario = tornata.orario || tornata.orario_inizio || '19:30:00';
    const orarioFormatted = orario.substring(0,5);
    const luogo = tornata.luogo || tornata.location || 'Tolfa';
    const titolo = tornata.titolo || tornata.discussione || 'Tornata Ordinaria';
    const tipo = tornata.tipo || 'ordinaria';
    
    // ‚úÖ AGGIUNGI INDICATORE TIPO LOGGIA
    const tipoLoggia = tornata.tipo_loggia || 'nostra';
    const loggiaIndicator = tipoLoggia === 'altra' ? 
        '<span style="background: #17a2b8; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üìç VISITA</span>' : 
        '<span style="background: #007bff; color: white; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 10px;">üèõÔ∏è NOSTRA</span>';
    
    // Verifica se il fratello ha gi√† confermato la presenza
    const presenzaConfermata = tornata.presenza_confermata;
    const statoPresenza = presenzaConfermata === 1 ? 'confermato-presente' : 
                         presenzaConfermata === 0 ? 'confermato-assente' : 'non-confermato';
    
    // üîß FIX APOSTROFI: Escape delle stringhe per evitare errori JavaScript
    const titoloSafe = titolo.replace(/'/g, "\\'").replace(/"/g, '\\"');
    const dataSafe = dataFormatted.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    return `
        <div class="tornata-item" data-tornata-id="${tornata.id}">
            <!-- ‚úÖ CLICK CORRETTO CON GESTIONE APOSTROFI -->
            <div class="tornata-info" onclick="apriModalPresenze(${tornata.id}, '${titoloSafe}', '${dataSafe}')" style="cursor: pointer;">
                <div class="tornata-data">üìÖ ${dataFormatted}</div>
                <div class="tornata-titolo">${titolo}</div>
                <div class="tornata-dettagli">
                    <span>üïê ${orarioFormatted}</span>
                    <span>üìç ${luogo}</span>
                    <span class="tornata-badge ${tipo}">${tipo.toUpperCase()}</span>
                    ${loggiaIndicator}
                    <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">üë• VEDI PRESENZE</span>
                </div>
            </div>
            <div class="presenza-controls">
                <div class="presenza-status">
                    <button class="presenza-btn presente ${statoPresenza === 'confermato-presente' ? 'confermato' : ''}" 
                            onclick="confermaPresenza('${tornata.id}', true)"
                            ${statoPresenza === 'confermato-presente' ? 'disabled' : ''}>
                        ‚úÖ PRESENTE
                    </button>
                    <button class="presenza-btn assente ${statoPresenza === 'confermato-assente' ? 'confermato' : ''}" 
                            onclick="confermaPresenza('${tornata.id}', false)"
                            ${statoPresenza === 'confermato-assente' ? 'disabled' : ''}>
                        ‚ùå ASSENTE
                    </button>
                </div>
                ${statoPresenza !== 'non-confermato' ? 
                    `<div class="presenza-status-text">
                        ${statoPresenza === 'confermato-presente' ? '‚úÖ Presenza confermata' : '‚ùå Assenza registrata'}
                    </div>` : ''
                }
            </div>
        </div>
    `;
}

// 2Ô∏è‚É£ FUNZIONE PER APRIRE IL MODAL

async function apriModalPresenze(tornataId, titoloTornata, dataTornata) {
    console.log(`üìã Apertura modal presenze per tornata ${tornataId}`);
    
    try {
        // Mostra loading
        const modalHTML = `
            <div id="modalPresenzeTornata" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;">
                <div style="background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 2px solid #f1f3f4;">
                        <h2 style="margin: 0; color: #333;">üìã PRESENZE TORNATA</h2>
                        <span onclick="chiudiModalPresenze()" style="font-size: 2rem; cursor: pointer; color: #999; line-height: 1;">&times;</span>
                    </div>
                    <div id="modalBody" style="padding: 20px;">
                        <div style="text-align: center; padding: 40px;">
                            <div style="border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                            <p>Caricamento presenze...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Chiamata API per ottenere presenze
        const response = await fetch(`/api/presenze/tornata/${tornataId}`);
        
        if (!response.ok) {
            throw new Error('Errore nel caricamento presenze');
        }
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.message || 'Errore dal server');
        }
        
        const { presenze, fratelli } = result.data;
        
        // Organizza i dati
        const presenti = [];
        const assenti = [];
        const nonRisposto = [];
        
        // Crea mappa delle presenze
        const presenzeMap = {};
        presenze.forEach(p => {
            presenzeMap[p.fratello_id] = p.presente;
        });
        
        // Classifica tutti i fratelli
        fratelli.forEach(fratello => {
            if (!fratello.attivo) return; // Salta fratelli non attivi
            
            const statoPresenza = presenzeMap[fratello.id];
            
            if (statoPresenza === 1) {
                presenti.push(fratello);
            } else if (statoPresenza === 0) {
                assenti.push(fratello);
            } else {
                nonRisposto.push(fratello);
            }
        });
        
        // Calcola percentuale
        const totaleAttivi = presenti.length + assenti.length + nonRisposto.length;
        const percentuale = totaleAttivi > 0 ? Math.round((presenti.length / totaleAttivi) * 100) : 0;
        
        // Genera HTML del modal
        const modalContent = generaContentModalPresenze(
            titoloTornata, 
            dataTornata, 
            presenti, 
            assenti, 
            nonRisposto, 
            percentuale
        );
        
        // Aggiorna il modal
        document.getElementById('modalBody').innerHTML = modalContent;
        
    } catch (error) {
        console.error('‚ùå Errore caricamento presenze:', error);
        
        const errorHTML = `
            <div style="text-align: center; padding: 40px; color: #dc3545;">
                <h3>‚ùå Errore</h3>
                <p>Impossibile caricare le presenze: ${error.message}</p>
                <button onclick="chiudiModalPresenze()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
                    Chiudi
                </button>
            </div>
        `;
        
        const modalBody = document.getElementById('modalBody');
        if (modalBody) {
            modalBody.innerHTML = errorHTML;
        }
    }
}

// 3Ô∏è‚É£ FUNZIONE PER GENERARE IL CONTENUTO

function generaContentModalPresenze(titolo, data, presenti, assenti, nonRisposto, percentuale) {
    const formatFratello = (fratello) => {
        const ruolo = fratello.ruolo || 'Fratello';
        const grado = fratello.grado || '';
        return `<li style="padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                    <strong>${fratello.nome}</strong> - ${ruolo}
                    ${grado ? `<span style="color: #666; font-size: 0.9em;"> (${grado})</span>` : ''}
                </li>`;
    };
    
    return `
        <div style="margin-bottom: 20px; text-align: center; background: #f8f9fa; padding: 15px; border-radius: 10px;">
            <h3 style="margin: 0 0 5px 0; color: #333;">${titolo}</h3>
            <p style="margin: 0; color: #666; font-size: 1.1rem;">${data}</p>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            
            <!-- PRESENTI -->
            <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 12px; padding: 15px;">
                <h4 style="margin: 0 0 15px 0; color: #155724; display: flex; align-items: center; gap: 8px;">
                    ‚úÖ PRESENTI (${presenti.length})
                </h4>
                <ul style="list-style: none; margin: 0; padding: 0; max-height: 200px; overflow-y: auto;">
                    ${presenti.length > 0 ? presenti.map(formatFratello).join('') : '<li style="color: #6c757d; font-style: italic;">Nessun presente</li>'}
                </ul>
            </div>
            
            <!-- ASSENTI -->
            <div style="background: linear-gradient(135deg, #f8d7da, #f5c6cb); border-radius: 12px; padding: 15px;">
                <h4 style="margin: 0 0 15px 0; color: #721c24; display: flex; align-items: center; gap: 8px;">
                    ‚ùå ASSENTI (${assenti.length})
                </h4>
                <ul style="list-style: none; margin: 0; padding: 0; max-height: 200px; overflow-y: auto;">
                    ${assenti.length > 0 ? assenti.map(formatFratello).join('') : '<li style="color: #6c757d; font-style: italic;">Nessun assente</li>'}
                </ul>
            </div>
            
            <!-- NON HANNO RISPOSTO -->
            <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-radius: 12px; padding: 15px;">
                <h4 style="margin: 0 0 15px 0; color: #856404; display: flex; align-items: center; gap: 8px;">
                    ‚è≥ NON HANNO RISPOSTO (${nonRisposto.length})
                </h4>
                <ul style="list-style: none; margin: 0; padding: 0; max-height: 200px; overflow-y: auto;">
                    ${nonRisposto.length > 0 ? nonRisposto.map(formatFratello).join('') : '<li style="color: #6c757d; font-style: italic;">Tutti hanno risposto</li>'}
                </ul>
            </div>
        </div>
        
        <!-- RIEPILOGO -->
        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); border-radius: 12px; padding: 20px; text-align: center;">
            <h3 style="margin: 0 0 10px 0; color: #1565c0;">üìä RIEPILOGO</h3>
            <p style="margin: 0; font-size: 1.2rem; color: #333;">
                <strong>${presenti.length} presenti</strong> su <strong>${presenti.length + assenti.length + nonRisposto.length} fratelli attivi</strong>
            </p>
            <p style="margin: 5px 0 0 0; font-size: 1.5rem; font-weight: bold; color: ${percentuale >= 70 ? '#28a745' : percentuale >= 50 ? '#ffc107' : '#dc3545'};">
                ${percentuale}% di partecipazione
            </p>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <button onclick="chiudiModalPresenze()" style="background: #6c757d; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                Chiudi
            </button>
        </div>
    `;
}

// 4Ô∏è‚É£ FUNZIONE PER CHIUDERE IL MODAL

function chiudiModalPresenze() {
    const modal = document.getElementById('modalPresenzeTornata');
    if (modal) {
        modal.remove();
    }
}

// 5Ô∏è‚É£ AGGIUNGI EVENTO CLICK FUORI DAL MODAL:

document.addEventListener('click', function(event) {
    const modal = document.getElementById('modalPresenzeTornata');
    if (modal && event.target === modal) {
        chiudiModalPresenze();
    }
});

// 6Ô∏è‚É£ AGGIUNGI GESTIONE ESC:

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        chiudiModalPresenze();
    }
});
        // Conferma presenza per una tornata
        async function confermaPresenza(tornataId, presente) {
            try {
                console.log(`üìù Confermando ${presente ? 'presenza' : 'assenza'} per tornata ${tornataId}`);
                
                // Mostra loading sui bottoni
                const tornataElement = document.querySelector(`[data-tornata-id="${tornataId}"]`);
                const buttons = tornataElement.querySelectorAll('.presenza-btn');
                
                buttons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                    if (btn.classList.contains(presente ? 'presente' : 'assente')) {
                        btn.innerHTML = '‚è≥ Salvando...';
                    }
                });
                
                // Chiamata API per salvare la presenza
                const response = await fetch('/api/presenze/conferma', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fratelloId: fratelliAuth.id,
                        tornataId: tornataId,
                        presente: presente,
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üíæ Risposta server:', result);
                    
                    // Aggiorna l'interfaccia con successo
                    updatePresenceUI(tornataId, presente);
                    
                    // Mostra messaggio di successo
                    const messaggio = presente ? 
                        `‚úÖ Presenza confermata per la tornata!` : 
                        `‚ùå Assenza registrata per la tornata.`;
                    
                    showAlert(messaggio, presente ? 'success' : 'warning');
                    
                    // Ricarica le statistiche per aggiornare i conteggi
                    setTimeout(() => {
                        loadStatistiche();
                        updateLastUpdate(); // Aggiorna timestamp
                    }, 500);
                    
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Errore nel salvataggio');
                }
                
            } catch (error) {
                console.error('‚ùå Errore conferma presenza:', error);
                
                // Ripristina i bottoni in caso di errore
                const tornataElement = document.querySelector(`[data-tornata-id="${tornataId}"]`);
                const buttons = tornataElement.querySelectorAll('.presenza-btn');
                
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                });
                
                // Ripristina il testo dei bottoni
                const presenteBtn = tornataElement.querySelector('.presenza-btn.presente');
                const assenteBtn = tornataElement.querySelector('.presenza-btn.assente');
                presenteBtn.innerHTML = '‚úÖ PRESENTE';
                assenteBtn.innerHTML = '‚ùå ASSENTE';
                
                showAlert('‚ùå Errore nel salvataggio della presenza. Riprova.', 'error');
            }
        }

        // Aggiorna UI dopo conferma presenza
        function updatePresenceUI(tornataId, presente) {
            const tornataElement = document.querySelector(`[data-tornata-id="${tornataId}"]`);
            if (!tornataElement) return;
            
            const presenteBtn = tornataElement.querySelector('.presenza-btn.presente');
            const assenteBtn = tornataElement.querySelector('.presenza-btn.assente');
            const statusContainer = tornataElement.querySelector('.presenza-controls');
            
            // Rimuovi classi precedenti
            presenteBtn.classList.remove('confermato');
            assenteBtn.classList.remove('confermato');
            presenteBtn.disabled = false;
            assenteBtn.disabled = false;
            
            // Applica nuovo stato
            if (presente) {
                presenteBtn.classList.add('confermato');
                presenteBtn.disabled = true;
                presenteBtn.innerHTML = '‚úÖ PRESENTE';
                assenteBtn.innerHTML = '‚ùå ASSENTE';
            } else {
                assenteBtn.classList.add('confermato');
                assenteBtn.disabled = true;
                assenteBtn.innerHTML = '‚ùå ASSENTE';
                presenteBtn.innerHTML = '‚úÖ PRESENTE';
            }
            
            // Aggiorna/aggiungi il testo di stato
            let statusText = statusContainer.querySelector('.presenza-status-text');
            if (!statusText) {
                statusText = document.createElement('div');
                statusText.className = 'presenza-status-text';
                statusContainer.appendChild(statusText);
            }
            
            statusText.innerHTML = presente ? 
                '‚úÖ Presenza confermata' : 
                '‚ùå Assenza registrata';
            
            // Reset opacit√†
            presenteBtn.style.opacity = '1';
            assenteBtn.style.opacity = '1';
        }

        // Formatta data italiana
        function formatDateItalian(dateString) {
            try {
                // Estrai solo YYYY-MM-DD
                const dateOnly = dateString.substring(0, 10);
                const [year, month, day] = dateOnly.split('-');
                
                const mesi = ['gennaio', 'febbraio', 'marzo', 'aprile', 'maggio', 'giugno',
                             'luglio', 'agosto', 'settembre', 'ottobre', 'novembre', 'dicembre'];
                
                const giorni = ['domenica', 'luned√¨', 'marted√¨', 'mercoled√¨', 'gioved√¨', 'venerd√¨', 'sabato'];
                
                // Crea data con anno, mese-1, giorno (locale)
                const localDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                
                return `${giorni[localDate.getDay()]} ${parseInt(day)} ${mesi[parseInt(month) - 1]} ${year}`;
                
            } catch (error) {
                console.error('Errore formattazione:', error);
                return dateString;
            }
        }

        // Logout
        function logout() {
            if (confirm('Sei sicuro di voler uscire dall\'area riservata?')) {
                sessionStorage.removeItem('fratelliAuth');
                window.location.href = '/';
            }
        }

        // Mostra alert con stili migliorati
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            // Icone per i diversi tipi di alert
            const icons = {
                success: '‚úÖ',
                warning: '‚ö†Ô∏è',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };
            
            const icon = icons[type] || '‚ÑπÔ∏è';
            
            alertContainer.innerHTML = `
                <div id="${alertId}" class="alert alert-${type}" style="transform: translateY(-10px); opacity: 0;">
                    ${icon} ${message}
                </div>
            `;
            
            // Animazione di entrata
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.style.transform = 'translateY(0)';
                    alertElement.style.opacity = '1';
                    alertElement.style.transition = 'all 0.3s ease';
                }
            }, 10);
            
            // Rimuovi alert dopo 5 secondi
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.style.opacity = '0';
                    alertElement.style.transform = 'translateY(-10px)';
                    setTimeout(() => alertElement.remove(), 300);
                }
            }, 5000);
        }

        // ========== GESTIONE TIMEOUT SESSIONE ==========
        
        // Inizializza monitoraggio sessione
        function initSessionMonitoring() {
            console.log('üîê Inizializzazione monitoraggio sessione (timeout: 10 minuti)');
            
            // Resetta i timer quando l'utente √® attivo
            const activityEvents = ['mousedown', 'keydown', 'scroll', 'touchstart', 'click'];
            activityEvents.forEach(event => {
                document.addEventListener(event, resetSessionTimer);
            });
            
            // Avvia il timer iniziale
            resetSessionTimer();
        }
        
        // Resetta il timer della sessione
        function resetSessionTimer() {
            lastActivityTime = Date.now();
            
            // Cancella i timer precedenti
            if (sessionTimer) clearTimeout(sessionTimer);
            if (warningTimer) clearTimeout(warningTimer);
            
            // Avviso a 9 minuti (1 minuto prima della scadenza)
            warningTimer = setTimeout(() => {
                showAlert('‚è∞ La tua sessione scadr√† tra 1 minuto per inattivit√†', 'warning');
            }, WARNING_TIME);
            
            // Logout automatico dopo 10 minuti
            sessionTimer = setTimeout(() => {
                console.log('‚è±Ô∏è Sessione scaduta per inattivit√† (10 minuti)');
                sessionExpired();
            }, SESSION_TIMEOUT);
        }
        
        // Gestione scadenza sessione
        function sessionExpired() {
            // Mostra messaggio
            alert('‚è±Ô∏è La tua sessione √® scaduta per inattivit√†.\nVerrai reindirizzato alla pagina di login.');
            
            // Pulisci sessione e reindirizza
            sessionStorage.removeItem('fratelliAuth');
            
            // Logout lato server
            fetch('/api/fratelli/logout', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            }).catch(err => console.error('Errore logout:', err));
            
            // Reindirizza al login
            window.location.href = '/fratelli/login';
        }
        
        // Verifica periodica dello stato della sessione (ogni 30 secondi)
        setInterval(() => {
            const timeSinceActivity = Date.now() - lastActivityTime;
            
            // Se sono passati pi√π di 10 minuti dall'ultima attivit√†
            if (timeSinceActivity >= SESSION_TIMEOUT) {
                console.log('‚è±Ô∏è Sessione scaduta rilevata dal controllo periodico');
                sessionExpired();
            }
        }, 30000); // Controlla ogni 30 secondi
    </script>

    <!-- PWA Registration -->
    <script src="/js/pwa-register.js"></script>
</body>
</html>